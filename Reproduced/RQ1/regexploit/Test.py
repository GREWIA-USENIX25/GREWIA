import os
import subprocess
import concurrent.futures
from tqdm import tqdm


# 读取/home/supermaxine/Documents/USENIX24/AttackStringGen/regex_set/regexes下1.txt到736535.txt
# path = '/Evaluation/regexploit/regexes'
path = '/Evaluation/regexes'
count = 0


files = os.listdir(path)   # 读入文件夹
num = len(files)       # 统计文件夹中的文件个数

begin = 1
end = 736536

pbar = tqdm(total=(end-begin))

# 定义一个函数，用于执行任务
def do_task(id):
    # print("-"*20, "\nsubmits task {}".format(id), "/", 736535, "\n", "-"*20)
    output = os.popen("timeout --preserve-status -k 5 600 python3 main.py {}".format(os.path.join(path, str(id)+'.txt')))
    # print("-"*20, "\ntask {} is done".format(id),"\n", output.read(), "\n", "-"*20)
    pbar.update(1)

with concurrent.futures.ThreadPoolExecutor(max_workers=int(os.cpu_count() * 0.8)) as executor:
    # 使用线程池执行任务
    for i in range(begin, num):
        executor.submit(do_task, i)